{% extends "base.html" %}
{% block title %}Settings - Library Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-gear"></i> Settings</h2>
    <span class="text-muted">v{{ version }}</span>
</div>

<!-- Quick Tutorial (remembers dismissal) -->
<div class="alert alert-info alert-dismissible fade show mb-4" role="alert" id="how-it-works-banner">
    <h5 class="alert-heading"><i class="bi bi-lightbulb"></i> How It Works</h5>
    <hr>
    <div class="row">
        <div class="col-md-4">
            <strong>1. Scan</strong><br>
            <small>Finds audiobook folders with messy names like:<br>
            <code>Unknown/Mistborn Book 1</code></small>
        </div>
        <div class="col-md-4">
            <strong>2. Lookup & Verify</strong><br>
            <small>Searches 4 book databases + AI to find correct metadata with smart verification</small>
        </div>
        <div class="col-md-4">
            <strong>3. Fix</strong><br>
            <small>Renames to clean format:<br>
            <code>Brandon Sanderson/The Final Empire</code></small>
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="dismissHowItWorks()"></button>
</div>

<!-- Main Settings Form -->
<form method="POST" id="settings-form">
    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-library" type="button">
                <i class="bi bi-folder"></i> Library
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-processing" type="button">
                <i class="bi bi-cpu"></i> Processing
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ai" type="button">
                <i class="bi bi-robot"></i> AI Setup
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-safety" type="button">
                <i class="bi bi-shield-check"></i> Safety
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-advanced" type="button">
                <i class="bi bi-gear-wide-connected"></i> Advanced
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">

        <!-- ==================== LIBRARY TAB ==================== -->
        <div class="tab-pane fade show active" id="tab-library">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Library Paths -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-folder"></i> Library Paths
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Paths to scan <small class="text-muted">(one per line)</small></label>
                                <textarea class="form-control bg-dark text-light" name="library_paths" id="library_paths" rows="3"
                                          placeholder="/mnt/audiobooks">{{ config.library_paths | join('\n') }}</textarea>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="testLibraryPaths()">
                                        <i class="bi bi-folder-check"></i> Test Paths
                                    </button>
                                    <small class="text-muted ms-2">Check if paths are accessible</small>
                                </div>
                                <div id="path-test-results" class="mt-2" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Folder Naming Format -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-pencil"></i> Folder Naming
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">Naming Format</label>
                                <select class="form-select bg-dark text-light" name="naming_format" id="naming_format" onchange="toggleCustomNaming()">
                                    <option value="author/title" {% if config.naming_format == 'author/title' or (not config.naming_format and not config.custom_naming_template) %}selected{% endif %}>
                                        Author/Title - Audiobookshelf, Plex, Jellyfin
                                    </option>
                                    <option value="author - title" {% if config.naming_format == 'author - title' %}selected{% endif %}>
                                        Author - Title (flat) - Booksonic, basic players
                                    </option>
                                    <option value="custom" {% if config.naming_format == 'custom' %}selected{% endif %}>
                                        Custom Template
                                    </option>
                                </select>
                            </div>

                            <!-- Custom Naming Template Builder -->
                            <div id="custom-naming-builder" class="mt-3" style="display: none;">
                                <label class="form-label">Custom Template</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control bg-dark text-light font-monospace"
                                           name="custom_naming_template" id="custom_naming_template"
                                           value="{{ config.custom_naming_template or '{author}/{title}' }}"
                                           placeholder="{author}/{title}"
                                           oninput="updateNamingPreview()">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearNamingTemplate()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">Click to add:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-info naming-tag" onclick="insertTag('{author}')">{author}</button>
                                        <button type="button" class="btn btn-sm btn-outline-info naming-tag" onclick="insertTag('{title}')">{title}</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning naming-tag" onclick="insertTag('{series}')">{series}</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning naming-tag" onclick="insertTag('{series_num}')">{series_num}</button>
                                        <button type="button" class="btn btn-sm btn-outline-success naming-tag" onclick="insertTag('{narrator}')">{narrator}</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary naming-tag" onclick="insertTag('{year}')">{year}</button>
                                    </div>
                                </div>

                                <div class="alert alert-dark small py-2 mb-0">
                                    <strong>Preview:</strong> <code id="preview-output">Brandon Sanderson/The Final Empire</code>
                                </div>
                            </div>

                            <hr class="my-3">

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="series_grouping" id="series_grouping"
                                       {% if config.series_grouping %}checked{% endif %}>
                                <label class="form-check-label" for="series_grouping">
                                    <strong>Series Grouping</strong>
                                    <br><small class="text-muted">Use <code>Author/Series/1 - Title/</code> format</small>
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="standardize_author_initials" id="standardize_author_initials"
                                       {% if config.standardize_author_initials %}checked{% endif %}>
                                <label class="form-check-label" for="standardize_author_initials">
                                    <strong>Standardize Author Initials</strong>
                                    <br><small class="text-muted">Normalize to <code>J. R. R. Tolkien</code> format</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Watch Folder -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-eye"></i> Watch Folder
                            <span class="badge bg-info float-end">NEW</span>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="watch_mode" id="watch_mode"
                                       {% if config.watch_mode %}checked{% endif %} onchange="toggleWatchOptions()">
                                <label class="form-check-label" for="watch_mode">
                                    <strong>Enable Watch Folder</strong>
                                    <br><small class="text-muted">Auto-organize new audiobooks from a folder</small>
                                </label>
                            </div>
                            <div id="watch-options" class="mt-3" style="display: {% if config.watch_mode %}block{% else %}none{% endif %};">
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Input Folder</label>
                                    <input type="text" class="form-control form-control-sm bg-dark text-light"
                                           name="watch_folder" id="watch_folder" value="{{ config.watch_folder or '' }}"
                                           placeholder="/path/to/downloads">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Output Folder <small class="text-muted">(optional)</small></label>
                                    <input type="text" class="form-control form-control-sm bg-dark text-light"
                                           name="watch_output_folder" id="watch_output_folder" value="{{ config.watch_output_folder or '' }}"
                                           placeholder="Defaults to first library path">
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <label class="form-label small mb-1">Check Interval</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control bg-dark text-light"
                                                   name="watch_interval_seconds" value="{{ config.watch_interval_seconds or 60 }}" min="10">
                                            <span class="input-group-text bg-dark text-light">sec</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small mb-1">Min File Age</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control bg-dark text-light"
                                                   name="watch_min_file_age_seconds" value="{{ config.watch_min_file_age_seconds or 30 }}" min="5">
                                            <span class="input-group-text bg-dark text-light">sec</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-switch mb-1">
                                    <input class="form-check-input" type="checkbox" name="watch_use_hard_links" id="watch_use_hard_links"
                                           {% if config.watch_use_hard_links %}checked{% endif %}>
                                    <label class="form-check-label small" for="watch_use_hard_links">Use hard links (same filesystem)</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="watch_delete_empty_folders" id="watch_delete_empty_folders"
                                           {% if config.watch_delete_empty_folders is not defined or config.watch_delete_empty_folders %}checked{% endif %}>
                                    <label class="form-check-label small" for="watch_delete_empty_folders">Delete empty folders after moving</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ebook Management -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-book"></i> Ebook Management
                            <span class="badge bg-info float-end">BETA</span>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="ebook_management" id="ebook_management"
                                       {% if config.ebook_management %}checked{% endif %} onchange="toggleEbookOptions()">
                                <label class="form-check-label" for="ebook_management">
                                    <strong>Enable Ebook Management</strong>
                                    <br><small class="text-muted">Organize .epub, .mobi, .azw3, .pdf files</small>
                                </label>
                            </div>
                            <div id="ebook-options" class="mt-2" style="display: {% if config.ebook_management %}block{% else %}none{% endif %};">
                                <label class="form-label small">Library Mode</label>
                                <select class="form-select form-select-sm bg-dark text-light" name="ebook_library_mode">
                                    <option value="merge" {% if config.ebook_library_mode == 'merge' %}selected{% endif %}>
                                        Merge with Audiobooks (ABS)
                                    </option>
                                    <option value="separate" {% if config.ebook_library_mode == 'separate' %}selected{% endif %}>
                                        Separate Ebook Library
                                    </option>
                                </select>
                                <small class="text-muted d-block mt-1">Merge puts ebooks in same Author/Title/ folder as audiobook</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PROCESSING TAB ==================== -->
        <div class="tab-pane fade" id="tab-processing">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Background Processing -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-play-circle"></i> Background Processing
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="enabled" id="enabled"
                                       {% if config.enabled %}checked{% endif %}>
                                <label class="form-check-label" for="enabled">
                                    <strong>Enable Background Processing</strong>
                                    <br><small class="text-muted">Automatically process queue items in the background</small>
                                </label>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label class="form-label small">Scan Interval</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control bg-dark text-light" name="scan_interval_hours"
                                               value="{{ config.scan_interval_hours }}" min="1" max="168">
                                        <span class="input-group-text bg-dark text-light">hours</span>
                                    </div>
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small">Batch Size</label>
                                    <input type="number" class="form-control form-control-sm bg-dark text-light" name="batch_size"
                                           value="{{ config.batch_size }}" min="1" max="10">
                                </div>
                            </div>
                            <div class="mb-0">
                                <label class="form-label small">Max API Calls/Hour</label>
                                <input type="number" class="form-control form-control-sm bg-dark text-light" name="max_requests_per_hour"
                                       value="{{ config.max_requests_per_hour }}" min="1" max="500" style="max-width: 120px;">
                            </div>
                        </div>
                    </div>

                    <!-- Confidence -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-sliders"></i> Confidence Settings
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="deep_scan_mode"
                                       id="deep_scan_mode" {% if config.deep_scan_mode %}checked{% endif %}>
                                <label class="form-check-label" for="deep_scan_mode">
                                    <strong>Deep Scan Mode</strong>
                                    <br><small class="text-muted">Run ALL enabled layers for every book (slower, more thorough)</small>
                                </label>
                            </div>

                            <div class="mb-0">
                                <label class="form-label">Confidence Threshold: <strong id="threshold-display">{{ config.profile_confidence_threshold or 85 }}%</strong></label>
                                <input type="range" class="form-range" name="profile_confidence_threshold"
                                       id="profile_confidence_threshold" min="50" max="100" step="5"
                                       value="{{ config.profile_confidence_threshold or 85 }}"
                                       oninput="document.getElementById('threshold-display').textContent = this.value + '%'">
                                <small class="text-muted">Higher = more certain before stopping, lower = faster</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Identification Sources -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-layers"></i> Identification Layers
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Books are identified in order. Each layer only runs if the previous one didn't get a confident match.
                            </p>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="enable_api_lookups"
                                       id="enable_api_lookups" {% if config.enable_api_lookups != false %}checked{% endif %}>
                                <label class="form-check-label" for="enable_api_lookups">
                                    <i class="bi bi-cloud text-info"></i> <strong>Layer 1: Database Lookups</strong>
                                    <span class="badge bg-success">Free</span>
                                    <br><small class="text-muted">BookDB, Audnexus, OpenLibrary, Google Books</small>
                                </label>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="enable_ai_verification"
                                       id="enable_ai_verification" {% if config.enable_ai_verification != false %}checked{% endif %}>
                                <label class="form-check-label" for="enable_ai_verification">
                                    <i class="bi bi-robot text-warning"></i> <strong>Layer 2: AI Verification</strong>
                                    <span class="badge bg-warning text-dark">Uses Tokens</span>
                                    <br><small class="text-muted">Ask AI when databases don't have a confident match</small>
                                </label>
                            </div>

                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="enable_audio_analysis"
                                       id="enable_audio_analysis" {% if config.enable_audio_analysis %}checked{% endif %}
                                       {% if not config.gemini_api_key %}disabled title="Requires Gemini API key"{% endif %}>
                                <label class="form-check-label" for="enable_audio_analysis">
                                    <i class="bi bi-soundwave text-danger"></i> <strong>Layer 3: Audio Analysis</strong>
                                    <span class="badge bg-warning text-dark">Uses Tokens</span>
                                    {% if not config.gemini_api_key %}<span class="badge bg-secondary">Needs Gemini</span>{% endif %}
                                    <br><small class="text-muted">Listen to first 90 seconds for narrator intro</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== AI SETUP TAB ==================== -->
        <div class="tab-pane fade" id="tab-ai">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-robot"></i> AI Provider
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <select class="form-select bg-dark text-light" name="ai_provider" id="ai_provider" onchange="toggleProviderFields()">
                                    <option value="gemini" {% if config.ai_provider == 'gemini' %}selected{% endif %}>
                                        Google Gemini (Recommended - 14,400 free calls/day)
                                    </option>
                                    <option value="openrouter" {% if config.ai_provider == 'openrouter' %}selected{% endif %}>
                                        OpenRouter (Free models available)
                                    </option>
                                    <option value="ollama" {% if config.ai_provider == 'ollama' %}selected{% endif %}>
                                        Ollama (Self-hosted - No API costs)
                                    </option>
                                </select>
                            </div>

                            <!-- Gemini Settings -->
                            <div id="gemini-settings">
                                <div class="mb-3">
                                    <label class="form-label">Gemini API Key</label>
                                    <input type="password" class="form-control bg-dark text-light" name="gemini_api_key"
                                           value="{{ config.gemini_api_key or '' }}" placeholder="AIza...">
                                    <small class="text-muted">Free at <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a></small>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label">Model</label>
                                    <select class="form-select bg-dark text-light" name="gemini_model">
                                        <option value="gemma-3-27b-it" {% if config.gemini_model == 'gemma-3-27b-it' %}selected{% endif %}>Gemma 3 27B (Best)</option>
                                        <option value="gemma-3-12b-it" {% if config.gemini_model == 'gemma-3-12b-it' %}selected{% endif %}>Gemma 3 12B (Faster)</option>
                                        <option value="gemini-2.0-flash" {% if config.gemini_model == 'gemini-2.0-flash' %}selected{% endif %}>Gemini 2.0 Flash</option>
                                    </select>
                                </div>
                            </div>

                            <!-- OpenRouter Settings -->
                            <div id="openrouter-settings" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">OpenRouter API Key</label>
                                    <input type="password" class="form-control bg-dark text-light" name="openrouter_api_key"
                                           value="{{ config.openrouter_api_key or '' }}" placeholder="sk-or-v1-...">
                                    <small class="text-muted">Get at <a href="https://openrouter.ai" target="_blank">openrouter.ai</a></small>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label">Model</label>
                                    <select class="form-select bg-dark text-light" name="openrouter_model">
                                        <option value="google/gemma-3n-e4b-it:free" {% if config.openrouter_model == 'google/gemma-3n-e4b-it:free' %}selected{% endif %}>Google Gemma 3N (Free)</option>
                                        <option value="meta-llama/llama-3.3-70b-instruct:free" {% if config.openrouter_model == 'meta-llama/llama-3.3-70b-instruct:free' %}selected{% endif %}>Llama 3.3 70B (Free)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Ollama Settings -->
                            <div id="ollama-settings" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Ollama Server URL</label>
                                    <input type="text" class="form-control bg-dark text-light" name="ollama_url" id="ollama_url"
                                           value="{{ config.ollama_url or 'http://localhost:11434' }}" placeholder="http://localhost:11434">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Model</label>
                                    <div class="input-group">
                                        <select class="form-select bg-dark text-light" name="ollama_model" id="ollama_model">
                                            {% if config.ollama_model %}
                                            <option value="{{ config.ollama_model }}" selected>{{ config.ollama_model }}</option>
                                            {% else %}
                                            <option value="llama3.2:3b" selected>llama3.2:3b (default)</option>
                                            {% endif %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary" onclick="refreshOllamaModels()" title="Refresh">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="testOllamaConnection()">
                                        <i class="bi bi-plug"></i> Test Connection
                                    </button>
                                    <span id="ollama-status" class="ms-2"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-cloud-download"></i> Book Metadata Sources
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">Searches these APIs in order (all free, no setup needed):</p>
                            <ol class="small mb-3">
                                <li><strong>Audnexus</strong> - Audiobooks (from Audible)</li>
                                <li><strong>OpenLibrary</strong> - General books</li>
                                <li><strong>Google Books</strong> - Wide coverage</li>
                                <li><strong>Hardcover</strong> - Indie/modern books</li>
                                <li><strong>AI Fallback</strong> - When APIs fail</li>
                            </ol>
                            <div class="mb-0">
                                <label class="form-label small">Google Books API Key <span class="text-muted">(optional)</span></label>
                                <input type="password" class="form-control form-control-sm bg-dark text-light" name="google_books_api_key"
                                       value="{{ config.google_books_api_key or '' }}" placeholder="For higher rate limits">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SAFETY TAB ==================== -->
        <div class="tab-pane fade" id="tab-safety">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Auto-Apply Settings -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-lightning"></i> Automation
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="auto_fix" id="auto_fix"
                                       {% if config.auto_fix %}checked{% endif %} onchange="warnAutoFix(this)">
                                <label class="form-check-label" for="auto_fix">
                                    <strong>Auto-Apply Fixes</strong>
                                    <span class="badge bg-warning text-dark">Caution</span>
                                    <br><small class="text-muted">Apply safe fixes automatically (non-drastic changes only)</small>
                                </label>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="protect_author_changes" id="protect_author_changes"
                                       {% if config.protect_author_changes %}checked{% endif %}>
                                <label class="form-check-label" for="protect_author_changes">
                                    <strong>Require Approval for Author Changes</strong>
                                    <span class="badge bg-success">Recommended</span>
                                    <br><small class="text-muted">When author changes completely (e.g. "Unknown" → "Stephen King"), send to Pending</small>
                                </label>
                            </div>

                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="trust_the_process" id="trust_the_process"
                                       {% if config.trust_the_process %}checked{% endif %} onchange="warnTrustTheProcess(this)">
                                <label class="form-check-label" for="trust_the_process">
                                    <strong>Trust the Process</strong>
                                    <span class="badge bg-danger">EXPERIMENTAL</span>
                                    <br><small class="text-muted">Auto-apply drastic changes if AI + audio analysis agree</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- UI Behavior -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-ui-checks"></i> UI Behavior
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="skip_confirmations" id="skip_confirmations"
                                       {% if config.skip_confirmations %}checked{% endif %}>
                                <label class="form-check-label" for="skip_confirmations">
                                    <strong>Skip Confirmation Dialogs</strong>
                                    <br><small class="text-muted">No "Are you sure?" popups when clicking Apply, Reject, or Undo</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Metadata Embedding -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-tags"></i> Metadata Embedding
                            <span class="badge bg-info float-end">BETA</span>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="metadata_embedding_enabled" id="metadata_embedding_enabled"
                                       {% if config.metadata_embedding_enabled %}checked{% endif %} onchange="toggleEmbeddingOptions()">
                                <label class="form-check-label" for="metadata_embedding_enabled">
                                    <strong>Enable Metadata Embedding</strong>
                                    <br><small class="text-muted">Write metadata tags into audio files when fixes are applied</small>
                                </label>
                            </div>
                            <div id="embedding-options" class="ms-4" style="display: {% if config.metadata_embedding_enabled %}block{% else %}none{% endif %};">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="metadata_embedding_overwrite_managed" id="metadata_embedding_overwrite_managed"
                                           {% if config.metadata_embedding_overwrite_managed %}checked{% endif %}>
                                    <label class="form-check-label small" for="metadata_embedding_overwrite_managed">
                                        Overwrite existing tags (title/author/series/narrator/year)
                                    </label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="metadata_embedding_backup_sidecar" id="metadata_embedding_backup_sidecar"
                                           {% if config.metadata_embedding_backup_sidecar %}checked{% endif %}>
                                    <label class="form-check-label small" for="metadata_embedding_backup_sidecar">
                                        Create backup before modifying tags
                                    </label>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Supports MP3, M4B/M4A, FLAC, Ogg/Opus, WMA
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ADVANCED TAB ==================== -->
        <div class="tab-pane fade" id="tab-advanced">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Language -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-translate"></i> Language
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Preferred Metadata Language</label>
                                <select class="form-select bg-dark text-light" name="preferred_language" id="preferred_language">
                                    <option value="en" {% if config.preferred_language == 'en' or not config.preferred_language %}selected{% endif %}>English (en)</option>
                                    <option value="de" {% if config.preferred_language == 'de' %}selected{% endif %}>German / Deutsch (de)</option>
                                    <option value="fr" {% if config.preferred_language == 'fr' %}selected{% endif %}>French / Français (fr)</option>
                                    <option value="es" {% if config.preferred_language == 'es' %}selected{% endif %}>Spanish / Español (es)</option>
                                    <option value="it" {% if config.preferred_language == 'it' %}selected{% endif %}>Italian / Italiano (it)</option>
                                    <option value="pt" {% if config.preferred_language == 'pt' %}selected{% endif %}>Portuguese / Português (pt)</option>
                                    <option value="nl" {% if config.preferred_language == 'nl' %}selected{% endif %}>Dutch / Nederlands (nl)</option>
                                    <option value="sv" {% if config.preferred_language == 'sv' %}selected{% endif %}>Swedish / Svenska (sv)</option>
                                    <option value="ja" {% if config.preferred_language == 'ja' %}selected{% endif %}>Japanese / 日本語 (ja)</option>
                                    <option value="zh" {% if config.preferred_language == 'zh' %}selected{% endif %}>Chinese / 中文 (zh)</option>
                                </select>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="preserve_original_titles" id="preserve_original_titles"
                                       {% if config.preserve_original_titles is not defined or config.preserve_original_titles %}checked{% endif %}>
                                <label class="form-check-label" for="preserve_original_titles">
                                    <strong>Preserve Original Titles</strong>
                                    <br><small class="text-muted">Keep foreign language titles instead of translating</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="detect_language_from_audio" id="detect_language_from_audio"
                                       {% if config.detect_language_from_audio %}checked{% endif %}>
                                <label class="form-check-label" for="detect_language_from_audio">
                                    <strong>Detect Language from Audio</strong>
                                    <span class="badge bg-info">BETA</span>
                                    <br><small class="text-muted">Use Gemini to detect spoken language</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Error Reporting -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-send"></i> Error Reporting
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" name="anonymous_error_reporting" id="anonymous_error_reporting"
                                       {% if config.anonymous_error_reporting %}checked{% endif %} onchange="toggleErrorReportingOptions()">
                                <label class="form-check-label" for="anonymous_error_reporting">
                                    <strong>Anonymous Error Reporting</strong>
                                    <br><small class="text-muted">Help improve Library Manager by sharing anonymous error reports</small>
                                </label>
                            </div>
                            <div id="error-reporting-options" class="ms-4" style="display: {% if config.anonymous_error_reporting %}block{% else %}none{% endif %};">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="error_reporting_include_titles" id="error_reporting_include_titles"
                                           {% if config.error_reporting_include_titles %}checked{% endif %}>
                                    <label class="form-check-label small" for="error_reporting_include_titles">
                                        Include book title/author when they caused the error
                                    </label>
                                </div>
                                <small class="text-muted d-block">
                                    <strong>Never collected:</strong> File paths, API keys, usernames
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Updates -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-arrow-repeat"></i> Updates
                        </div>
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select form-select-sm bg-dark text-light" name="update_channel" style="max-width: 150px;">
                                    <option value="stable" {% if config.update_channel == 'stable' %}selected{% endif %}>Stable</option>
                                    <option value="beta" {% if config.update_channel == 'beta' %}selected{% endif %}>Beta</option>
                                    <option value="nightly" {% if config.update_channel == 'nightly' %}selected{% endif %}>Nightly</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="checkUpdateNow()">
                                    <i class="bi bi-arrow-clockwise"></i> Check
                                </button>
                                <span id="update-status"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="card mb-3 border-danger">
                        <div class="card-header py-2 text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Danger Zone
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">These actions cannot be undone.</p>
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearHistory()">
                                    <i class="bi bi-trash"></i> Clear History
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="resetDatabase()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Reset Database
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <!-- Backup & Restore -->
                    <div class="card mb-3 border-info">
                        <div class="card-header py-2 text-info">
                            <i class="bi bi-cloud-arrow-down"></i> Backup & Restore
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 flex-wrap mb-3">
                                <a href="/api/backup" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-download"></i> Download Backup
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="showRestoreModal()">
                                    <i class="bi bi-upload"></i> Restore Backup
                                </button>
                            </div>
                            <div id="backup-info" class="small text-muted">
                                <i class="bi bi-hourglass-split"></i> Loading backup info...
                            </div>
                        </div>
                    </div>

                    <!-- Debug -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-bug"></i> Debug & Troubleshooting
                        </div>
                        <div class="card-body">
                            <div class="row small mb-2">
                                <div class="col-6"><strong>Version:</strong> <span class="text-info">{{ version }}</span></div>
                                <div class="col-6"><strong>AI:</strong> <span class="text-info">{{ config.ai_provider }}</span></div>
                            </div>
                            <hr class="my-2">
                            <div class="mb-2">
                                <strong class="small">API Tests</strong>
                                <div class="d-flex flex-wrap gap-1 mt-1">
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0" onclick="testBookDB()">BookDB</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0" onclick="testGemini()">Gemini</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0" onclick="testOpenRouter()">OpenRouter</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary py-0" onclick="testOllamaDebug()">Ollama</button>
                                </div>
                                <div id="api-test-results" class="mt-1 small"></div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex flex-wrap gap-1">
                                <button type="button" class="btn btn-sm btn-outline-info py-0" onclick="generateBugReport()">Bug Report</button>
                                <button type="button" class="btn btn-sm btn-outline-warning py-0" onclick="clearQueueFromSettings()">Clear Queue</button>
                                <button type="button" class="btn btn-sm btn-outline-warning py-0" onclick="clearAllHistoryErrors()">Clear Errors</button>
                            </div>
                            <div id="bug-report-output" class="mt-2 d-none">
                                <textarea class="form-control form-control-sm bg-dark text-light" id="bug-report-text" rows="4" readonly></textarea>
                                <button type="button" class="btn btn-sm btn-success mt-1 py-0" onclick="copyBugReport()">Copy</button>
                            </div>
                        </div>
                    </div>

                    <!-- Logs -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-terminal"></i> Recent Logs
                            <button type="button" class="btn btn-sm btn-outline-secondary float-end py-0" onclick="refreshLogs()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="card-body bg-dark p-2" style="max-height: 300px; overflow-y: auto;">
                            <pre id="log-output" class="mb-0 text-light" style="font-size: 0.7rem; white-space: pre-wrap;">Loading...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button (sticky) -->
    <div class="position-sticky bottom-0 bg-dark py-3 border-top mt-3" style="z-index: 100;">
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Settings
            </button>
        </div>
    </div>
</form>

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload"></i> Restore Backup</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> Restoring will overwrite your current settings and database.
                </div>
                <form id="restore-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Select Backup File</label>
                        <input type="file" class="form-control bg-dark text-light" name="backup" accept=".zip" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="restoreBackup()">
                    <i class="bi bi-upload"></i> Restore
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Check if "How It Works" banner should be hidden
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('hideHowItWorks') === 'true') {
        const banner = document.getElementById('how-it-works-banner');
        if (banner) banner.style.display = 'none';
    }
    toggleProviderFields();
    toggleCustomNaming();
    toggleEbookOptions();
    toggleWatchOptions();
    updateNamingPreview();
    refreshLogs();
});

function dismissHowItWorks() {
    localStorage.setItem('hideHowItWorks', 'true');
}

function toggleProviderFields() {
    const provider = document.getElementById('ai_provider').value;
    document.getElementById('gemini-settings').style.display = provider === 'gemini' ? 'block' : 'none';
    document.getElementById('openrouter-settings').style.display = provider === 'openrouter' ? 'block' : 'none';
    document.getElementById('ollama-settings').style.display = provider === 'ollama' ? 'block' : 'none';
    if (provider === 'ollama') refreshOllamaModels();
}

function testOllamaConnection() {
    const statusEl = document.getElementById('ollama-status');
    const url = document.getElementById('ollama_url').value;
    statusEl.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i></span>';
    fetch('/api/test_ollama', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ollama_url: url})
    })
    .then(r => r.json())
    .then(data => {
        statusEl.innerHTML = data.success
            ? '<span class="text-success"><i class="bi bi-check-circle"></i> Connected</span>'
            : '<span class="text-danger"><i class="bi bi-x-circle"></i> ' + (data.error || 'Failed') + '</span>';
    })
    .catch(e => { statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Error</span>'; });
}

function refreshOllamaModels() {
    const url = document.getElementById('ollama_url').value;
    const select = document.getElementById('ollama_model');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Loading...</option>';
    select.disabled = true;
    fetch('/api/ollama_models', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ollama_url: url})
    })
    .then(r => r.json())
    .then(data => {
        select.disabled = false;
        if (data.success && data.models && data.models.length > 0) {
            select.innerHTML = '';
            data.models.forEach(model => {
                const opt = document.createElement('option');
                opt.value = model;
                opt.textContent = model;
                if (model === currentValue) opt.selected = true;
                select.appendChild(opt);
            });
        } else {
            select.innerHTML = '<option value="llama3.2:3b">llama3.2:3b</option><option value="mistral:7b">mistral:7b</option>';
        }
    })
    .catch(e => {
        select.disabled = false;
        select.innerHTML = '<option value="llama3.2:3b">llama3.2:3b</option>';
    });
}

function toggleEbookOptions() {
    document.getElementById('ebook-options').style.display = document.getElementById('ebook_management').checked ? 'block' : 'none';
}

function toggleEmbeddingOptions() {
    document.getElementById('embedding-options').style.display = document.getElementById('metadata_embedding_enabled').checked ? 'block' : 'none';
}

function toggleWatchOptions() {
    document.getElementById('watch-options').style.display = document.getElementById('watch_mode').checked ? 'block' : 'none';
}

function toggleErrorReportingOptions() {
    document.getElementById('error-reporting-options').style.display = document.getElementById('anonymous_error_reporting').checked ? 'block' : 'none';
}

// Custom Naming
const sampleData = {author: 'Brandon Sanderson', title: 'The Final Empire', series: 'Mistborn', series_num: '1', narrator: 'Michael Kramer', year: '2006'};

function toggleCustomNaming() {
    const builder = document.getElementById('custom-naming-builder');
    if (builder) {
        builder.style.display = document.getElementById('naming_format').value === 'custom' ? 'block' : 'none';
        updateNamingPreview();
    }
}

function insertTag(tag) {
    const input = document.getElementById('custom_naming_template');
    const start = input.selectionStart;
    input.value = input.value.substring(0, start) + tag + input.value.substring(input.selectionEnd);
    input.focus();
    input.setSelectionRange(start + tag.length, start + tag.length);
    updateNamingPreview();
}

function clearNamingTemplate() {
    document.getElementById('custom_naming_template').value = '';
    updateNamingPreview();
}

function updateNamingPreview() {
    let preview = document.getElementById('custom_naming_template').value || '{author}/{title}';
    Object.keys(sampleData).forEach(key => { preview = preview.replace(new RegExp(`\\{${key}\\}`, 'g'), sampleData[key] || ''); });
    preview = preview.replace(/\(\s*\)/g, '').replace(/\/+/g, '/').replace(/\s{2,}/g, ' ').trim();
    document.getElementById('preview-output').textContent = preview || '(empty)';
}

// Logs
function refreshLogs() {
    fetch('/api/logs').then(r => r.json()).then(data => {
        const logEl = document.getElementById('log-output');
        if (data.logs && data.logs.length > 0) {
            logEl.innerHTML = data.logs.map(line => {
                if (line.includes('ERROR')) return `<span class="text-danger">${escapeHtml(line)}</span>`;
                if (line.includes('WARNING')) return `<span class="text-warning">${escapeHtml(line)}</span>`;
                if (line.includes('VERIFIED') || line.includes('Fixed:')) return `<span class="text-success">${escapeHtml(line)}</span>`;
                return escapeHtml(line);
            }).join('\n');
            logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
        } else {
            logEl.textContent = 'No recent logs';
        }
    }).catch(e => { document.getElementById('log-output').textContent = 'Error: ' + e; });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// API Tests
function showApiTestResult(msg, success) {
    const el = document.getElementById('api-test-results');
    el.innerHTML = `<span class="${success ? 'text-success' : 'text-danger'}"><i class="bi bi-${success ? 'check' : 'x'}-circle"></i> ${escapeHtml(msg)}</span>`;
}

function testBookDB() {
    showApiTestResult('Testing...', true);
    fetch('/api/test_bookdb', {method: 'POST'}).then(r => r.json())
        .then(data => showApiTestResult(data.success ? 'BookDB: OK' : 'BookDB: ' + (data.error || 'Failed'), data.success))
        .catch(e => showApiTestResult('BookDB: ' + e, false));
}

function testGemini() {
    showApiTestResult('Testing...', true);
    fetch('/api/test_gemini', {method: 'POST'}).then(r => r.json())
        .then(data => showApiTestResult(data.success ? 'Gemini: OK' : 'Gemini: ' + (data.error || 'Failed'), data.success))
        .catch(e => showApiTestResult('Gemini: ' + e, false));
}

function testOpenRouter() {
    showApiTestResult('Testing...', true);
    fetch('/api/test_openrouter', {method: 'POST'}).then(r => r.json())
        .then(data => showApiTestResult(data.success ? 'OpenRouter: OK' : 'OpenRouter: ' + (data.error || 'Failed'), data.success))
        .catch(e => showApiTestResult('OpenRouter: ' + e, false));
}

function testOllamaDebug() {
    showApiTestResult('Testing...', true);
    const url = document.getElementById('ollama_url')?.value || 'http://localhost:11434';
    fetch('/api/test_ollama', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ollama_url: url})})
        .then(r => r.json())
        .then(data => showApiTestResult(data.success ? 'Ollama: OK' : 'Ollama: ' + (data.error || 'Failed'), data.success))
        .catch(e => showApiTestResult('Ollama: ' + e, false));
}

// Warnings
function warnAutoFix(checkbox) {
    if (checkbox.checked && !confirm('Auto-Fix will rename folders automatically. Make sure you have backups!\n\nEnable?')) {
        checkbox.checked = false;
    }
}

function warnTrustTheProcess(checkbox) {
    if (checkbox.checked) {
        if (!confirm('TRUST THE PROCESS MODE\n\nThis enables FULLY AUTOMATIC verification with AI + audio analysis.\n\nMake sure you have BACKUPS!\n\nEnable?')) {
            checkbox.checked = false;
            return;
        }
        document.getElementById('auto_fix').checked = true;
        document.getElementById('enable_audio_analysis').checked = true;
        document.getElementById('detect_language_from_audio').checked = true;
    }
}

// Actions
function checkUpdateNow() {
    const el = document.getElementById('update-status');
    el.innerHTML = '<span class="text-info small"><i class="bi bi-hourglass-split"></i></span>';
    fetch('/api/check_update').then(r => r.json()).then(data => {
        el.innerHTML = data.update_available
            ? `<a href="${data.release_url}" target="_blank" class="btn btn-sm btn-success py-0">${data.latest}</a>`
            : '<span class="text-success small"><i class="bi bi-check"></i></span>';
    }).catch(() => { el.innerHTML = '<span class="text-danger small"><i class="bi bi-x"></i></span>'; });
}

function clearHistory() {
    if (!confirm('Clear all history? Cannot be undone.')) return;
    fetch('/api/clear_history', {method: 'POST'}).then(() => location.reload());
}

function resetDatabase() {
    if (!confirm('Reset ENTIRE database? All data will be lost!')) return;
    if (!confirm('REALLY sure?')) return;
    fetch('/api/reset_database', {method: 'POST'}).then(() => location.reload());
}

function clearQueueFromSettings() {
    if (!confirm('Clear the entire queue?')) return;
    fetch('/api/clear_queue', {method: 'POST'}).then(r => r.json()).then(data => alert(data.message || 'Done'));
}

function clearAllHistoryErrors() {
    if (!confirm('Clear all error entries from history?')) return;
    fetch('/api/clear_all_errors', {method: 'POST'}).then(r => r.json()).then(data => alert(data.message || 'Done'));
}

function generateBugReport() {
    fetch('/api/bug_report').then(r => r.json()).then(data => {
        document.getElementById('bug-report-output').classList.remove('d-none');
        document.getElementById('bug-report-text').value = data.report;
    });
}

function copyBugReport() {
    document.getElementById('bug-report-text').select();
    document.execCommand('copy');
    alert('Copied!');
}

// Backup & Restore
let restoreModal = null;

function loadBackupInfo() {
    fetch('/api/backup/info').then(r => r.json()).then(data => {
        const el = document.getElementById('backup-info');
        if (data.files && data.files.length > 0) {
            el.innerHTML = `<strong>Includes:</strong> ${data.files.map(f => f.name).join(', ')} (${data.total_size_human})`;
        } else {
            el.innerHTML = 'No files to backup';
        }
    }).catch(e => { document.getElementById('backup-info').innerHTML = '<span class="text-danger">Error</span>'; });
}

function showRestoreModal() {
    if (!restoreModal) restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
    restoreModal.show();
}

function restoreBackup() {
    const fileInput = document.querySelector('#restore-form input[name="backup"]');
    if (!fileInput.files || !fileInput.files.length) { alert('Select a backup file'); return; }
    if (!confirm('Restore from this backup?')) return;
    const formData = new FormData();
    formData.append('backup', fileInput.files[0]);
    fetch('/api/restore', {method: 'POST', body: formData})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                restoreModal.hide();
                if (confirm('Reload page?')) location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed'));
            }
        })
        .catch(e => alert('Error: ' + e));
}

document.querySelector('[data-bs-target="#tab-advanced"]')?.addEventListener('shown.bs.tab', loadBackupInfo);

// Library path test
function testLibraryPaths() {
    const paths = document.getElementById('library_paths').value.split('\n').map(p => p.trim()).filter(p => p);
    const resultsDiv = document.getElementById('path-test-results');
    if (!paths.length) { resultsDiv.innerHTML = '<div class="alert alert-warning py-2">No paths to test</div>'; resultsDiv.style.display = 'block'; return; }
    resultsDiv.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split"></i> Testing...</div>';
    resultsDiv.style.display = 'block';
    let html = '', completed = 0;
    paths.forEach(path => {
        fetch('/api/check_path', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({path: path})})
            .then(r => r.json())
            .then(data => {
                completed++;
                html += data.success
                    ? `<div class="alert alert-success py-2 mb-1"><i class="bi bi-check-circle"></i> <strong>${escapeHtml(path)}</strong> - OK (${data.total_entries || 0} items)</div>`
                    : `<div class="alert alert-danger py-2 mb-1"><i class="bi bi-x-circle"></i> <strong>${escapeHtml(path)}</strong> - ${escapeHtml(data.error || 'Not accessible')}</div>`;
                if (completed === paths.length) resultsDiv.innerHTML = html;
            })
            .catch(e => { completed++; html += `<div class="alert alert-danger py-2 mb-1">${escapeHtml(path)} - Error</div>`; if (completed === paths.length) resultsDiv.innerHTML = html; });
    });
}

setInterval(refreshLogs, 10000);
</script>
{% endblock %}
