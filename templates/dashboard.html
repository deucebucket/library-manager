{% extends "base.html" %}
{% block title %}{{ _('Dashboard') }} - {{ _('Library Manager') }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card h-100" title="{{ _('All audiobook folders found in your library') }}">
            <div class="card-body text-center">
                <i class="bi bi-collection text-info" style="font-size: 2rem;"></i>
                <div class="stat-number" id="total-books">{{ total_books }}</div>
                <div class="text-muted">{{ _('Total Books') }}</div>
                <small class="text-muted" style="font-size: 0.7rem;">{{ _('in library') }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <a href="/queue" class="text-decoration-none">
            <div class="card stat-card h-100" title="{{ _('Books waiting to be analyzed by AI') }}" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-list-task text-warning" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="queue-count">{{ queue_size }}</div>
                    <div class="text-muted">{{ _('In Queue') }}</div>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ _('awaiting AI analysis') }}</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/history" class="text-decoration-none">
            <div class="card stat-card h-100" title="{{ _('Books that have been renamed/corrected') }}" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="fixed-count">{{ fixed_count }}</div>
                    <div class="text-muted">{{ _('Fixed') }}</div>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ _('renamed successfully') }}</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/history?status=pending" class="text-decoration-none">
            <div class="card stat-card h-100" title="{{ _('AI suggested fixes waiting to be applied to files') }}" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-hourglass-split text-danger" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="pending-fixes">{{ pending_fixes }}</div>
                    <div class="text-muted">{{ _('Pending Fixes') }}</div>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ _('ready to apply') }}</small>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Floating Quick Actions Button -->
<div class="position-fixed bottom-0 end-0 m-4" style="z-index: 1050;">
    <div class="dropup">
        <button class="btn btn-primary btn-lg rounded-circle shadow" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width: 60px; height: 60px;">
            <i class="bi bi-lightning-fill fs-4"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow mb-2" style="min-width: 200px;">
            <li><h6 class="dropdown-header">{{ _('Quick Actions') }}</h6></li>
            <li><a class="dropdown-item" href="#" onclick="triggerScan(); return false;" id="scan-btn">
                <i class="bi bi-search text-primary"></i> {{ _('Scan Library') }}
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="deepRescan(); return false;" id="deep-scan-btn">
                <i class="bi bi-arrow-repeat text-info"></i> {{ _('Deep Re-scan') }}
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="processQueue(); return false;" id="process-btn">
                <i class="bi bi-play-fill text-success"></i> {{ _('Process Queue') }}
            </a></li>
            {% if pending_fixes > 0 %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="applyAllPending(); return false;" id="apply-pending-btn">
                <i class="bi bi-check-all text-warning"></i> {{ _('Apply %(count)s Pending', count=pending_fixes) }}
            </a></li>
            {% endif %}
            <li><hr class="dropdown-divider"></li>
            {% if worker_running %}
            <li><a class="dropdown-item" href="#" onclick="stopWorker(); return false;">
                <i class="bi bi-stop-fill text-danger"></i> {{ _('Stop Worker') }}
            </a></li>
            {% else %}
            <li><a class="dropdown-item" href="#" onclick="startWorker(); return false;">
                <i class="bi bi-play-fill text-success"></i> {{ _('Start Worker') }}
            </a></li>
            {% endif %}
        </ul>
    </div>
</div>

<!-- Processing Activity Log - Shows ALL recent processing, not just fixes -->
<style>
    #activity-log-table { table-layout: fixed; width: 100%; }
    #activity-log-table td, #activity-log-table th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 0.35rem 0.5rem;
    }
    /* Marquee scroll on hover for truncated text */
    #activity-log-table td.scroll-text:hover {
        overflow: visible;
    }
    #activity-log-table td.scroll-text:hover span {
        display: inline-block;
        animation: marquee 4s linear infinite;
    }
    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
</style>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity"></i> Processing Activity (Last 15)</span>
                <small class="text-muted" id="activity-refresh-time">Auto-refreshes</small>
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm mb-0" id="activity-log-table">
                    <thead style="position: sticky; top: 0; background: rgba(22, 33, 62, 0.95);">
                        <tr>
                            <th style="width: 42px;">Time</th>
                            <th style="width: 16%;">Author</th>
                            <th style="width: 20%;">Title</th>
                            <th style="width: 14%;">Narrator</th>
                            <th style="width: 14%;">Series</th>
                            <th style="width: 28px;">#</th>
                            <th style="width: 55px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log-body">
                        <tr><td colspan="4" class="text-muted text-center py-3">Loading activity...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Pending Fixes - Now in separate section below -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Pending Fixes (Last 15)
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                {% if recent_history %}
                <table class="table table-sm mb-0" id="recent-activity-table">
                    <thead style="position: sticky; top: 0; background: rgba(22, 33, 62, 0.95);">
                        <tr>
                            <th>Date</th>
                            <th>Original</th>
                            <th></th>
                            <th>Fixed To</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in recent_history[:15] %}
                        <tr>
                            <td><small>{{ h.fixed_at[5:16] }}</small></td>
                            <td class="text-truncate" style="max-width: 200px;">
                                <span class="text-danger">{{ h.old_author }}</span> /
                                <span class="text-warning">{{ h.old_title }}</span>
                            </td>
                            <td><i class="bi bi-arrow-right text-info"></i></td>
                            <td class="text-truncate" style="max-width: 200px;">
                                <span class="text-success">{{ h.new_author }}</span> /
                                <span class="text-info">{{ h.new_title }}</span>
                            </td>
                            <td>
                                {% if h.status == 'undone' %}
                                <span class="badge bg-info" title="Rename was reverted to original">Undone</span>
                                {% elif h.status == 'fixed' %}
                                <span class="badge bg-success" title="Rename was applied successfully">Fixed</span>
                                {% elif h.status == 'error' %}
                                <span class="badge bg-danger" title="{{ h.error_message or 'Error' }}">Error</span>
                                {% elif h.status == 'duplicate' %}
                                <span class="badge bg-warning text-dark" title="Multiple copies of the same book detected">Duplicate</span>
                                {% elif h.status == 'conflict' %}
                                <span class="badge bg-warning text-dark" title="Destination folder already exists with different content">Conflict</span>
                                {% elif h.status == 'corrupt_dest' %}
                                <span class="badge bg-danger" title="Destination path has issues - needs manual review">Corrupt</span>
                                {% elif h.status == 'pending_fix' %}
                                <span class="badge bg-secondary" title="Rename pending - click to review and apply">Pending</span>
                                {% elif h.status == 'attention' %}
                                <span class="badge bg-danger" title="Could not auto-identify - please edit manually">Needs Attention</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ h.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if h.status == 'fixed' and h.old_path != h.new_path %}
                                <button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="undoFix({{ h.id }})" title="Undo">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted p-3">No fixes yet. Scan and process the queue to get started.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Current Configuration
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Library Paths:</strong><br>
                        {% for path in config.library_paths %}
                        <code>{{ path }}</code><br>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <strong>AI Model:</strong> {{ config.openrouter_model }}<br>
                        <strong>Scan Interval:</strong> Every {{ config.scan_interval_hours }} hours<br>
                        <strong>Batch Size:</strong> {{ config.batch_size }} books
                    </div>
                    <div class="col-md-4">
                        <strong>Auto-Fix:</strong>
                        {% if config.auto_fix %}
                        <span class="badge bg-success">Enabled</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Manual Approval</span>
                        {% endif %}
                        <br>
                        <strong>Status:</strong>
                        {% if config.enabled %}
                        <span class="badge bg-success">Enabled</span>
                        {% else %}
                        <span class="badge bg-danger">Disabled</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function triggerScan() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning...';

    fetch('/api/scan', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search"></i> Scan Library';
            const alreadyCorrect = data.checked - data.queued;
            alert(`Scan complete!\n\nChecked: ${data.checked} books\nAlready correct: ${alreadyCorrect}\nNeed fixing: ${data.queued}`);
            location.reload();
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search"></i> Scan Library';
            alert('Error: ' + e);
        });
}

function deepRescan() {
    if (!confirm('Deep Re-scan will queue ALL books for fresh metadata verification using the new API chain. This may take a while. Continue?')) return;

    const btn = document.getElementById('deep-scan-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Resetting...';

    fetch('/api/deep_rescan', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Deep Re-scan (Verify All)';
            alert(data.message);
            location.reload();
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Deep Re-scan (Verify All)';
            alert('Error: ' + e);
        });
}

function processQueue() {
    const btn = document.getElementById('process-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

    fetch('/api/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({limit: 3})
    })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Process Queue (1 batch)';
            alert(`Processed! ${data.fixed} books analyzed.`);
            location.reload();
        })
        .catch(e => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Process Queue (1 batch)';
            alert('Error: ' + e);
        });
}

function startWorker() {
    fetch('/api/worker/start', {method: 'POST'})
        .then(r => r.json())
        .then(() => location.reload());
}

function stopWorker() {
    fetch('/api/worker/stop', {method: 'POST'})
        .then(r => r.json())
        .then(() => location.reload());
}

function applyAllPending() {
    if (!confirm('Apply all pending fixes? This will rename folders in your library.')) return;

    const btn = document.getElementById('apply-pending-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Applying...';

    fetch('/api/apply_all_pending', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(e => {
            btn.disabled = false;
            alert('Error: ' + e);
        });
}

function undoFix(historyId) {
    if (!confirm('Undo this fix? The folder will be renamed back to its original name.')) return;

    fetch(`/api/undo/${historyId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(e => alert('Error: ' + e));
}

// Auto-refresh stats and recent activity
function refreshDashboard() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            document.getElementById('total-books').textContent = data.total_books;
            document.getElementById('queue-count').textContent = data.queue_size;
            document.getElementById('fixed-count').textContent = data.fixed;
            document.getElementById('pending-fixes').textContent = data.pending_fixes || 0;
        })
        .catch(e => console.error('Stats refresh error:', e));

    // Refresh pending fixes table
    fetch('/api/recent_history')
        .then(r => r.json())
        .then(data => {
            const tbody = document.querySelector('#recent-activity-table tbody');
            if (tbody && data.items) {
                tbody.innerHTML = data.items.map(h => `
                    <tr>
                        <td><small>${h.fixed_at ? h.fixed_at.substring(5, 16) : ''}</small></td>
                        <td class="text-truncate" style="max-width: 200px;">
                            <span class="text-danger">${escapeHtml(h.old_author)}</span> /
                            <span class="text-warning">${escapeHtml(h.old_title)}</span>
                        </td>
                        <td><i class="bi bi-arrow-right text-info"></i></td>
                        <td class="text-truncate" style="max-width: 200px;">
                            <span class="text-success">${escapeHtml(h.new_author)}</span> /
                            <span class="text-info">${escapeHtml(h.new_title)}</span>
                        </td>
                        <td>
                            ${h.status === 'undone' ? '<span class="badge bg-info" title="Rename was reverted to original">Undone</span>' :
                              h.status === 'fixed' ? '<span class="badge bg-success" title="Rename was applied successfully">Fixed</span>' :
                              h.status === 'error' ? '<span class="badge bg-danger" title="' + escapeHtml(h.error_message || 'Error') + '">Error</span>' :
                              h.status === 'duplicate' ? '<span class="badge bg-warning text-dark" title="Multiple copies of the same book detected">Duplicate</span>' :
                              h.status === 'conflict' ? '<span class="badge bg-warning text-dark" title="Destination folder already exists with different content">Conflict</span>' :
                              h.status === 'corrupt_dest' ? '<span class="badge bg-danger" title="Destination path has issues - needs manual review">Corrupt</span>' :
                              h.status === 'pending_fix' ? '<span class="badge bg-secondary" title="Rename pending - click to review and apply">Pending</span>' :
                              h.status === 'attention' ? '<span class="badge bg-danger" title="Could not auto-identify - please edit manually">Needs Attention</span>' :
                              '<span class="badge bg-secondary">' + escapeHtml(h.status) + '</span>'}
                        </td>
                        <td>
                            ${h.status === 'fixed' && h.old_path !== h.new_path ?
                                `<button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="undoFix(${h.id})" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>` :
                                '-'}
                        </td>
                    </tr>
                `).join('');
            }
        })
        .catch(e => console.error('History refresh error:', e));

    // Refresh processing activity log (ALL recent processing, not just fixes)
    fetch('/api/recent_activity')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('activity-log-body');
            const timeEl = document.getElementById('activity-refresh-time');
            if (tbody && data.items) {
                if (data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-muted text-center py-3">No processing activity yet. Start a scan to begin.</td></tr>';
                } else {
                    tbody.innerHTML = data.items.map(item => {
                        const time = item.updated_at ? item.updated_at.substring(11, 16) : '';
                        const narratorDisplay = item.narrator_display || item.narrator || '-';
                        const narratorClass = item.is_author_narrated ? 'text-success fw-bold' : (item.narrator ? 'text-light' : 'text-muted');
                        const seriesStr = item.series || '-';
                        const bookNum = item.book_num || '-';
                        return `
                            <tr>
                                <td><small class="text-muted">${time}</small></td>
                                <td title="${escapeHtml(item.author)}" class="text-success">${escapeHtml(item.author)}</td>
                                <td title="${escapeHtml(item.title)}" class="text-warning">${escapeHtml(item.title)}</td>
                                <td title="${escapeHtml(item.narrator || '-')}" class="${narratorClass}">${narratorDisplay}</td>
                                <td title="${escapeHtml(seriesStr)}" class="${item.series ? 'text-info' : 'text-muted'}">${escapeHtml(seriesStr)}</td>
                                <td class="${item.book_num ? 'text-warning' : 'text-muted'}">${bookNum}</td>
                                <td><small>${item.status_display}</small></td>
                            </tr>
                        `;
                    }).join('');
                }
                if (timeEl) {
                    timeEl.textContent = new Date().toLocaleTimeString();
                }
            }
        })
        .catch(e => console.error('Activity refresh error:', e));
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Start auto-refresh immediately and every 5 seconds
refreshDashboard();
setInterval(refreshDashboard, 5000);
console.log('Dashboard auto-refresh active (every 5s)');
</script>
{% endblock %}
